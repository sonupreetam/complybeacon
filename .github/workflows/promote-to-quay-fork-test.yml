---
# Fork Test: Promote to Quay Workflow
# DELETE THIS FILE BEFORE MERGING TO UPSTREAM
name: "[Fork Test] Promote to Quay"

on:
  push:
    tags: ['v*.*.*', 'test-*']  # Also allow test-* tags for testing
  workflow_dispatch:
    inputs:
      source_sha:
        description: 'Source commit SHA to promote (defaults to tag commit)'
        required: false
        type: string
      dry_run:
        description: 'Dry run - skip actual promotion, just validate'
        required: false
        type: boolean
        default: false

permissions:
  packages: write
  id-token: write

concurrency:
  group: promote-to-quay-fork-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Debug job to show what would be promoted
  debug-info:
    runs-on: ubuntu-latest
    steps:
      - name: Show promotion info
        run: |
          echo "=== Promotion Info ==="
          echo "Repository Owner: ${{ github.repository_owner }}"
          echo "Source SHA: ${{ inputs.source_sha || github.sha }}"
          echo "Source Tag: sha-${{ inputs.source_sha || github.sha }}"
          echo "Dest Tag: ${{ github.ref_name }}"
          echo "Dry Run: ${{ inputs.dry_run }}"
          echo ""
          echo "=== Source Images (GHCR) ==="
          echo "ghcr.io/${{ github.repository_owner }}/complybeacon-compass:sha-${{ inputs.source_sha || github.sha }}"
          echo "ghcr.io/${{ github.repository_owner }}/complybeacon-beacon-distro:sha-${{ inputs.source_sha || github.sha }}"
          echo ""
          echo "=== Destination Images (Quay) ==="
          echo "quay.io/${{ github.repository_owner }}/complybeacon-compass:${{ github.ref_name }}"
          echo "quay.io/${{ github.repository_owner }}/complybeacon-beacon-distro:${{ github.ref_name }}"

  promote-compass:
    if: ${{ inputs.dry_run != true }}
    needs: debug-info
    uses: complytime/org-infra/.github/workflows/reusable_promote.yml@main
    with:
      source_registry: ghcr.io
      # Use fork namespace for source
      source_image: ${{ github.repository_owner }}/complybeacon-compass
      source_tag: sha-${{ inputs.source_sha || github.sha }}
      dest_registry: quay.io
      # Use fork namespace for destination
      dest_image: ${{ github.repository_owner }}/complybeacon-compass
      dest_tag: ${{ github.ref_name }}
      create_semver_tags: true
      verify_source_signature: true
      allowed_identity_regex: >-
        https://github.com/complytime/org-infra(/.*)?
    secrets:
      dest_username: ${{ secrets.QUAY_USERNAME }}
      dest_password: ${{ secrets.QUAY_PASSWORD }}

  sign-compass:
    if: ${{ inputs.dry_run != true }}
    needs: promote-compass
    permissions:
      packages: write
      id-token: write
    uses: complytime/org-infra/.github/workflows/reusable_sign_and_verify.yml@main
    with:
      # Use fork namespace
      image_name: quay.io/${{ github.repository_owner }}/complybeacon-compass
      digest: ${{ needs.promote-compass.outputs.digest }}
      allowed_identity_regex: >-
        https://github.com/complytime/org-infra(/.*)?
      verify_attestations: false
    secrets:
      quay_username: ${{ secrets.QUAY_USERNAME }}
      quay_password: ${{ secrets.QUAY_PASSWORD }}

  promote-beacon-distro:
    if: ${{ inputs.dry_run != true }}
    needs: debug-info
    uses: complytime/org-infra/.github/workflows/reusable_promote.yml@main
    with:
      source_registry: ghcr.io
      # Use fork namespace for source
      source_image: ${{ github.repository_owner }}/complybeacon-beacon-distro
      source_tag: sha-${{ inputs.source_sha || github.sha }}
      dest_registry: quay.io
      # Use fork namespace for destination
      dest_image: ${{ github.repository_owner }}/complybeacon-beacon-distro
      dest_tag: ${{ github.ref_name }}
      create_semver_tags: true
      verify_source_signature: true
      allowed_identity_regex: >-
        https://github.com/${{ github.repository }}(/.*)?
    secrets:
      dest_username: ${{ secrets.QUAY_USERNAME }}
      dest_password: ${{ secrets.QUAY_PASSWORD }}

  sign-beacon-distro:
    if: ${{ inputs.dry_run != true }}
    needs: promote-beacon-distro
    permissions:
      packages: write
      id-token: write
    uses: complytime/org-infra/.github/workflows/reusable_sign_and_verify.yml@main
    with:
      # Use fork namespace
      image_name: quay.io/${{ github.repository_owner }}/complybeacon-beacon-distro
      digest: ${{ needs.promote-beacon-distro.outputs.digest }}
      allowed_identity_regex: >-
        https://github.com/complytime/org-infra(/.*)?
      verify_attestations: false
    secrets:
      quay_username: ${{ secrets.QUAY_USERNAME }}
      quay_password: ${{ secrets.QUAY_PASSWORD }}


---
# Fork Test: Promote to Quay Workflow
# DELETE THIS FILE BEFORE MERGING TO UPSTREAM
name: "[Fork Test] Promote to Quay"

on:
  push:
    tags: ['v*.*.*', 'test-*']  # Also allow test-* tags for testing
  workflow_dispatch:
    inputs:
      source_sha:
        description: 'Source commit SHA to promote (defaults to tag commit)'
        required: false
        type: string
      dry_run:
        description: 'Dry run - validate everything but skip actual promotion'
        required: false
        type: boolean
        default: true

permissions:
  packages: write
  id-token: write

concurrency:
  group: promote-to-quay-fork-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Validate and show what would be promoted
  validate:
    runs-on: ubuntu-latest
    outputs:
      source_sha: ${{ steps.info.outputs.source_sha }}
      source_tag: ${{ steps.info.outputs.source_tag }}
      compass_exists: ${{ steps.check.outputs.compass_exists }}
      beacon_exists: ${{ steps.check.outputs.beacon_exists }}
    steps:
      - name: Show promotion info
        id: info
        run: |
          SOURCE_SHA="${{ inputs.source_sha || github.sha }}"
          SOURCE_TAG="sha-${SOURCE_SHA}"
          
          echo "source_sha=${SOURCE_SHA}" >> $GITHUB_OUTPUT
          echo "source_tag=${SOURCE_TAG}" >> $GITHUB_OUTPUT
          
          echo "=== Promotion Info ==="
          echo "Repository Owner: ${{ github.repository_owner }}"
          echo "Source SHA: ${SOURCE_SHA}"
          echo "Source Tag: ${SOURCE_TAG}"
          echo "Dest Tag: ${{ github.ref_name }}"
          echo "Dry Run: ${{ inputs.dry_run }}"
          echo ""
          echo "=== Source Images (GHCR) ==="
          echo "ghcr.io/${{ github.repository_owner }}/complybeacon-compass:${SOURCE_TAG}"
          echo "ghcr.io/${{ github.repository_owner }}/complybeacon-beacon-distro:${SOURCE_TAG}"
          echo ""
          echo "=== Destination Images (Quay) ==="
          echo "quay.io/${{ github.repository_owner }}/complybeacon-compass:${{ github.ref_name }}"
          echo "quay.io/${{ github.repository_owner }}/complybeacon-beacon-distro:${{ github.ref_name }}"

      - name: Check if source images exist
        id: check
        run: |
          echo "=== Checking Source Images ==="
          
          # Check compass image
          COMPASS_IMAGE="ghcr.io/${{ github.repository_owner }}/complybeacon-compass:sha-${{ inputs.source_sha || github.sha }}"
          echo "Checking: ${COMPASS_IMAGE}"
          if docker manifest inspect "${COMPASS_IMAGE}" > /dev/null 2>&1; then
            echo "âœ… Compass image exists"
            echo "compass_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Compass image NOT found"
            echo "compass_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # Check beacon-distro image
          BEACON_IMAGE="ghcr.io/${{ github.repository_owner }}/complybeacon-beacon-distro:sha-${{ inputs.source_sha || github.sha }}"
          echo "Checking: ${BEACON_IMAGE}"
          if docker manifest inspect "${BEACON_IMAGE}" > /dev/null 2>&1; then
            echo "âœ… Beacon-distro image exists"
            echo "beacon_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Beacon-distro image NOT found"
            echo "beacon_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Quay secrets
        run: |
          echo "=== Checking Secrets ==="
          if [ -n "${{ secrets.QUAY_USERNAME }}" ]; then
            echo "âœ… QUAY_USERNAME is set"
          else
            echo "âŒ QUAY_USERNAME is NOT set"
          fi
          
          if [ -n "${{ secrets.QUAY_PASSWORD }}" ]; then
            echo "âœ… QUAY_PASSWORD is set"
          else
            echo "âŒ QUAY_PASSWORD is NOT set"
          fi

      - name: Validation summary
        run: |
          echo "=== Validation Summary ==="
          echo ""
          
          READY=true
          
          if [ "${{ steps.check.outputs.compass_exists }}" != "true" ]; then
            echo "âŒ FAIL: Compass source image not found"
            READY=false
          else
            echo "âœ… PASS: Compass source image exists"
          fi
          
          if [ "${{ steps.check.outputs.beacon_exists }}" != "true" ]; then
            echo "âŒ FAIL: Beacon-distro source image not found"
            READY=false
          else
            echo "âœ… PASS: Beacon-distro source image exists"
          fi
          
          echo ""
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "ðŸ”µ DRY RUN MODE - Promotion jobs will be skipped"
            echo ""
            echo "To run the actual promotion:"
            echo "  1. Ensure source images exist (run Publish Images workflow first)"
            echo "  2. Re-run this workflow with 'Dry run' UNCHECKED"
          else
            if [ "$READY" == "true" ]; then
              echo "ðŸŸ¢ READY - Proceeding with promotion"
            else
              echo "ðŸ”´ NOT READY - Fix the issues above before promoting"
              exit 1
            fi
          fi

  promote-compass:
    if: ${{ inputs.dry_run != true }}
    needs: validate
    uses: complytime/org-infra/.github/workflows/reusable_promote.yml@main
    with:
      source_registry: ghcr.io
      source_image: ${{ github.repository_owner }}/complybeacon-compass
      source_tag: sha-${{ inputs.source_sha || github.sha }}
      dest_registry: quay.io
      dest_image: ${{ github.repository_owner }}/complybeacon-compass
      dest_tag: ${{ github.ref_name }}
      create_semver_tags: true
      verify_source_signature: true
      allowed_identity_regex: >-
        https://github.com/complytime/org-infra(/.*)?
    secrets:
      dest_username: ${{ secrets.QUAY_USERNAME }}
      dest_password: ${{ secrets.QUAY_PASSWORD }}

  sign-compass:
    if: ${{ inputs.dry_run != true }}
    needs: promote-compass
    permissions:
      packages: write
      id-token: write
    uses: complytime/org-infra/.github/workflows/reusable_sign_and_verify.yml@main
    with:
      image_name: quay.io/${{ github.repository_owner }}/complybeacon-compass
      digest: ${{ needs.promote-compass.outputs.digest }}
      allowed_identity_regex: >-
        https://github.com/complytime/org-infra(/.*)?
      verify_attestations: false
    secrets:
      quay_username: ${{ secrets.QUAY_USERNAME }}
      quay_password: ${{ secrets.QUAY_PASSWORD }}

  promote-beacon-distro:
    if: ${{ inputs.dry_run != true }}
    needs: validate
    uses: complytime/org-infra/.github/workflows/reusable_promote.yml@main
    with:
      source_registry: ghcr.io
      source_image: ${{ github.repository_owner }}/complybeacon-beacon-distro
      source_tag: sha-${{ inputs.source_sha || github.sha }}
      dest_registry: quay.io
      dest_image: ${{ github.repository_owner }}/complybeacon-beacon-distro
      dest_tag: ${{ github.ref_name }}
      create_semver_tags: true
      verify_source_signature: true
      allowed_identity_regex: >-
        https://github.com/${{ github.repository }}(/.*)?
    secrets:
      dest_username: ${{ secrets.QUAY_USERNAME }}
      dest_password: ${{ secrets.QUAY_PASSWORD }}

  sign-beacon-distro:
    if: ${{ inputs.dry_run != true }}
    needs: promote-beacon-distro
    permissions:
      packages: write
      id-token: write
    uses: complytime/org-infra/.github/workflows/reusable_sign_and_verify.yml@main
    with:
      image_name: quay.io/${{ github.repository_owner }}/complybeacon-beacon-distro
      digest: ${{ needs.promote-beacon-distro.outputs.digest }}
      allowed_identity_regex: >-
        https://github.com/complytime/org-infra(/.*)?
      verify_attestations: false
    secrets:
      quay_username: ${{ secrets.QUAY_USERNAME }}
      quay_password: ${{ secrets.QUAY_PASSWORD }}
